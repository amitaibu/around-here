<html>
<head>
	<title>Around Here</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	
 	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
	 <!--[if lte IE 8]>
    	 <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
 	<![endif]-->
	 
	<link rel="stylesheet" href="lib/leaflet.locate.css" />
	
	<style type="text/css">
		body {
		    padding: 0;
		    margin: 0;
		}
		html, body, #map {
		    height: 100%;
		}
		a {
			text-decoration: none;
		}
	</style>

	<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
	<script src="lib/leaflet.locate.js"></script>
	<script src="lib/leaflet.providers.js"></script>
	<!-- script src="lib/leaflet.label.js"></script -->
	
	<script src="lib/zepto.js"></script>
</head>

<body>
<div id="map"></div>
<script>

    // render wiki article locations as map markers
    function renderData(wiki_articles){    
    	wiki_articles.forEach(
    		function (item){
				marker = L.marker([item.lat, item.lon])
						.bindPopup("<a href=\"http://en.wikipedia.org/wiki?curid=" + item.pageid + "\" target='_self'>" + item.title + "</a>")
						.addTo(map);
    		}
    	);
    }


    // get it directly from Wikipedia API
    function getData(here){
    	$.ajax({
		    url: "https://en.wikipedia.org/w/api.php",
		    jsonp: "callback",
		    dataType: "jsonp",
		    data: {
		        gscoord: here.latlng.lat + '|' + here.latlng.lng,
		        action: 'query',
		        list: 'geosearch',
		        gsradius: 10000,
		        format:'json'
		    },
		    success: function(d) { console.log(d.query.geosearch) ; renderData(d.query.geosearch) }
		});

    }


    // location found, render map
	function onLocationFound(here) {
		L.circle(here.latlng, 10, { weight: 3, color: '#942EBD', fill: true, fillColor: '#EDED1C'}).addTo(map);
		getData(here);
	}


	// no access to location API, show message
	function onLocationError(e) {
		$('#map').html('<p style="margin:10%;padding:10%;background-color:white;text-align:center;font-size:2em">Please allow viewing location for this to work<br><a href="#" onclick="location.reload();">Okay</a></p>');

	}

	function homeLocation(){
		map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true, maximumAge: 10});
	}

	// --- start ---

	var map = L.map('map');

	// define map style
	L.tileLayer(
		// 'http://{s}.tiles.mapbox.com/v3/mapbox.mapbox-simple/{z}/{x}/{y}.png',
		//'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', 
		'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
		{
			maxZoom: 18
		}
	).addTo(map);


	// add "home" control
	L.control.locate({position: 'topright'}).addTo(map);


	// get current location
	map.on('locationfound', onLocationFound);
	map.on('locationerror', onLocationError);
	homeLocation();

	// get current location whenever the window is focused
	window.addEventListener(
		"focus", 
		function(e) { homeLocation(); }, 
		false
	);


</script>

</body>
</html>
